[
  {
    "source": "codex",
    "file": "sdf4j/src/main/native/src/type_conversion.c",
    "line": "300-449",
    "severity": "critical",
    "title": "Buffer overflow in ECC conversions (missing length clamps)",
    "problem": "The new code copies Java byte arrays directly into fixed-size ECC buffers without clamping to `ECCref_MAX_LEN`. If Java supplies longer arrays, this writes past the end of `ECCrefPublicKey`, `ECCSignature`, and `ECCCipher` fields, causing memory corruption.",
    "code": "jsize len = (*env)->GetArrayLength(env, x_array);\n(*env)->GetByteArrayRegion(env, x_array, 0, len, (jbyte*)native_key->x);\n...\njsize len = (*env)->GetArrayLength(env, y_array);\n(*env)->GetByteArrayRegion(env, y_array, 0, len, (jbyte*)native_key->y);",
    "fix": "jsize len = (*env)->GetArrayLength(env, x_array);\nif (len > ECCref_MAX_LEN) len = ECCref_MAX_LEN;\n(*env)->GetByteArrayRegion(env, x_array, 0, len, (jbyte*)native_key->x);\n\nlen = (*env)->GetArrayLength(env, y_array);\nif (len > ECCref_MAX_LEN) len = ECCref_MAX_LEN;\n(*env)->GetByteArrayRegion(env, y_array, 0, len, (jbyte*)native_key->y);"
  },
  {
    "source": "codex",
    "file": "sdf4j/src/main/native/src/type_conversion.c",
    "line": "667-678",
    "severity": "critical",
    "title": "Buffer overflow in ECC private key conversion",
    "problem": "`java_to_native_ECCPrivateKey` copies the Java `k` array into a fixed-size `ECCrefPrivateKey.K` buffer without clamping. Oversized input overflows the native struct.",
    "code": "jsize len = (*env)->GetArrayLength(env, k_array);\n(*env)->GetByteArrayRegion(env, k_array, 0, len, (jbyte*)native_key->K);",
    "fix": "memset(native_key, 0, sizeof(ECCrefPrivateKey));\njsize len = (*env)->GetArrayLength(env, k_array);\nif (len > ECCref_MAX_LEN) len = ECCref_MAX_LEN;\n(*env)->GetByteArrayRegion(env, k_array, 0, len, (jbyte*)native_key->K);"
  },
  {
    "source": "codex",
    "file": "sdf4j/src/main/native/src/sdf_jni_keygen.c",
    "line": "662-668",
    "severity": "high",
    "title": "Build break: undefined variable keyHandle",
    "problem": "The new `SDF_ImportKey` JNI method logs `keyHandle`, but the variable is named `key_handle`. This is a compile error.",
    "code": "SDF_LOG_EXIT(\"SDF_ImportKey\", ret);\nSDF_JNI_LOG(\"SDF_ImportKey: keyHandle=0x%lX\", (unsigned long)keyHandle);\nreturn (jlong)key_handle;",
    "fix": "SDF_LOG_EXIT(\"SDF_ImportKey\", ret);\nSDF_JNI_LOG(\"SDF_ImportKey: keyHandle=0x%lX\", (unsigned long)key_handle);\nreturn (jlong)key_handle;"
  },
  {
    "source": "codex",
    "file": "sdf4j/src/main/native/src/sdf_jni_symmetric.c",
    "line": "960-967",
    "severity": "high",
    "title": "Double ReleasePrimitiveArrayCritical on aad_buf",
    "problem": "`aad_buf` is released twice in `JNI_SDF_AuthDec`, which can corrupt JNI state or crash the JVM.",
    "code": "if (aad_buf != NULL) {\n    (*env)->ReleasePrimitiveArrayCritical(env, aad, aad_buf, JNI_ABORT);\n}\nif (aad_buf != NULL) {\n    (*env)->ReleasePrimitiveArrayCritical(env, aad, aad_buf, JNI_ABORT);\n}",
    "fix": "if (aad_buf != NULL) {\n    (*env)->ReleasePrimitiveArrayCritical(env, aad, aad_buf, JNI_ABORT);\n}"
  },
  {
    "source": "codex",
    "file": "sdf4j/src/main/native/src/sdf_jni_symmetric.c",
    "line": "1229-1236",
    "severity": "high",
    "title": "Invalid free() of pinned JNI array",
    "problem": "`aad_buf` is obtained via `GetPrimitiveArrayCritical` and must be released via `ReleasePrimitiveArrayCritical`. Calling `free(aad_buf)` is undefined behavior and can crash.",
    "code": "if (aad_buf != NULL) {\n    (*env)->ReleasePrimitiveArrayCritical(env, aad, aad_buf, JNI_ABORT);\n}\nif (aad_buf != NULL) free(aad_buf);",
    "fix": "if (aad_buf != NULL) {\n    (*env)->ReleasePrimitiveArrayCritical(env, aad, aad_buf, JNI_ABORT);\n}"
  },
  {
    "source": "codex",
    "file": "sdf4j/src/main/native/src/sdf_jni_util.c",
    "line": "405-448",
    "severity": "high",
    "title": "Invalid free() on GetPrimitiveArrayCritical buffers",
    "problem": "`key_buf`, `iv_buf`, and `enc_buf` are obtained via `GetPrimitiveArrayCritical` but are freed with `free(...)`. This is invalid and can cause memory corruption or JVM crashes, including in error paths.",
    "code": "if (iv_buf == NULL) {\n    free(key_buf);\n    throw_sdf_exception(env, 0x0100001C);\n    return NULL;\n}\n...\nif (enc_buf == NULL) {\n    free(key_buf);\n    if (iv_buf) free(iv_buf);\n    throw_sdf_exception(env, 0x0100001C);\n    return NULL;\n}\n...\nfree(key_buf);\nif (iv_buf) free(iv_buf);\nfree(enc_buf);",
    "fix": "if (iv_buf == NULL) {\n    (*env)->ReleasePrimitiveArrayCritical(env, key, key_buf, JNI_ABORT);\n    throw_sdf_exception(env, 0x0100001C);\n    return NULL;\n}\n...\nif (enc_buf == NULL) {\n    (*env)->ReleasePrimitiveArrayCritical(env, key, key_buf, JNI_ABORT);\n    if (iv_buf != NULL) {\n        (*env)->ReleasePrimitiveArrayCritical(env, iv, iv_buf, JNI_ABORT);\n    }\n    throw_sdf_exception(env, 0x0100001C);\n    return NULL;\n}\n...\n(*env)->ReleasePrimitiveArrayCritical(env, key, key_buf, JNI_ABORT);\nif (iv_buf != NULL) {\n    (*env)->ReleasePrimitiveArrayCritical(env, iv, iv_buf, JNI_ABORT);\n}\n(*env)->ReleasePrimitiveArrayCritical(env, encData, enc_buf, JNI_ABORT);"
  },
  {
    "source": "codex",
    "file": "sdf4j/src/main/java/org/openhitls/sdf4j/SDF.java",
    "line": "181-184",
    "severity": "medium",
    "title": "NullPointerException on CloseDevice when gDevHandle is null",
    "problem": "`deviceHandle != gDevHandle` auto-unboxes `gDevHandle`. If `SDF_CloseDevice` is called before `SDF_OpenDevice` or after a close, `gDevHandle` is null and this throws a NullPointerException instead of behaving as a no-op or clean error.",
    "code": "if (deviceHandle != gDevHandle) {\n    return;\n}",
    "fix": "if (gDevHandle == null || deviceHandle != gDevHandle.longValue()) {\n    return;\n}"
  },
  {
    "source": "codex",
    "file": "sdf4j/src/main/java/org/openhitls/sdf4j/SDF.java",
    "line": "216-221",
    "severity": "medium",
    "title": "OpenSession can throw NPE when device resource is missing",
    "problem": "`SessionResource` uses `gDevResource.addSession(...)` but `gDevResource` is only set in `SDF_OpenDevice`. Calling `SDF_OpenSession` without an open device (or after closing) now throws a NullPointerException instead of a controlled `SDFException`.",
    "code": "long handle = SDF_OpenSessionNative(deviceHandle);\n// 创建 SessionResource 并注册到 gDevResource 和 gSessResource\nSessionResource sessionResource = new SessionResource(handle);\ngSessResource.put(handle, sessionResource);",
    "fix": "if (gDevResource == null) {\n    throw new SDFException(SDR_INARGERR);\n}\nlong handle = SDF_OpenSessionNative(deviceHandle);\nSessionResource sessionResource = new SessionResource(handle);\ngSessResource.put(handle, sessionResource);"
  }
]