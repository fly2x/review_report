<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Review: openHiTLS/sdf4j#11 - GEMINI</title>
    <style>
        :root { --critical: #dc2626; --high: #ea580c; --medium: #ca8a04; --low: #65a30d; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: system-ui, sans-serif; background: #f8fafc; color: #1e293b; padding: 2rem; line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .subtitle { color: #64748b; margin-bottom: 2rem; }
        .section { margin-bottom: 2rem; }
        .section-title { font-size: 1.1rem; font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.5rem 0.5rem 0 0; color: white; }
        .section-title.critical { background: var(--critical); }
        .section-title.high { background: var(--high); }
        .section-title.medium { background: var(--medium); }
        .section-title.low { background: var(--low); }
        .issue { background: white; border: 1px solid #e2e8f0; border-top: none; padding: 1rem; }
        .issue:last-child { border-radius: 0 0 0.5rem 0.5rem; }
        .issue-title { font-weight: 600; margin-bottom: 0.25rem; }
        .issue-location { font-family: monospace; font-size: 0.875rem; color: #64748b; margin-bottom: 0.75rem; }
        .issue-source { font-size: 0.75rem; color: #94a3b8; margin-top: 0.5rem; }
        pre { background: #1e293b; color: #e2e8f0; padding: 0.75rem; border-radius: 0.375rem; overflow-x: auto; font-size: 0.875rem; margin: 0.5rem 0; }
        .problem { margin: 0.75rem 0; }
        .fix-label { font-weight: 600; margin-top: 0.75rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Code Review: openHiTLS/sdf4j#11 - GEMINI</h1>
        <div class="subtitle"></div>
<div class="section"><div class="section-title critical">Critical</div>
<div class="issue">
                <div class="issue-title">Plaintext Password Logging</div>
                <div class="issue-location">sdf4j/src/main/native/src/sdf_jni_device.c:220</div>
                <pre>SDF_JNI_LOG("SDF_GetPrivateKeyAccessRight: pwd='%s', pwd_len=%lu",
                pwd ? pwd : "(null)", (unsigned long)pwd_len);</pre>
                <div class="problem"><strong>Issue:</strong> The function `JNI_SDF_GetPrivateKeyAccessRight` logs the user's password in plaintext. This is a severe security vulnerability that leaks sensitive credentials to the application logs.</div>
                <div class="fix-label">Fix:</div><pre>SDF_JNI_LOG("SDF_GetPrivateKeyAccessRight: pwd='***', pwd_len=%lu",
                (unsigned long)pwd_len);</pre>
                <div class="issue-source">Reviewer: gemini</div>
            </div>
<div class="issue">
                <div class="issue-title">Plaintext Password Logging</div>
                <div class="issue-location">sdf4j/src/main/native/src/sdf_jni_device.c:282</div>
                <pre>SDF_JNI_LOG("SDF_GetKEKAccessRight: pwd='%s', pwd_len=%lu",
                pwd ? pwd : "(null)", (unsigned long)pwd_len);</pre>
                <div class="problem"><strong>Issue:</strong> The function `JNI_SDF_GetKEKAccessRight` logs the user's password in plaintext.</div>
                <div class="fix-label">Fix:</div><pre>SDF_JNI_LOG("SDF_GetKEKAccessRight: pwd='***', pwd_len=%lu",
                (unsigned long)pwd_len);</pre>
                <div class="issue-source">Reviewer: gemini</div>
            </div>
<div class="issue">
                <div class="issue-title">Heap Buffer Overflow in JNI_SDF_AuthEncFinal</div>
                <div class="issue-location">sdf4j/src/main/native/src/sdf_jni_symmetric.c:531-558</div>
                <pre>/* Convert pucEncData to native buffer */
    BYTE *output_buf = NULL;
    ULONG output_len = 0;
    if (pucEncData != NULL) {
        output_len = (*env)-&gt;GetArrayLength(env, pucEncData);
        output_buf = (BYTE*)malloc(output_len);
        if (output_buf == NULL) {
            throw_sdf_exception(env, 0x0100001C);
            return NULL;
        }
        (*env)-&gt;GetByteArrayRegion(env, pucEncData, 0, output_len, (jbyte*)output_buf);
    }</pre>
                <div class="problem"><strong>Issue:</strong> The function allocates `output_buf` based on the size of the input Java array `pucEncData`. The `SDF_AuthEncFinal` C function writes final ciphertext (padding) and authentication tag. If the user passes a small or empty array (e.g., `new byte[0]`), `malloc` allocates a small buffer, but `SDF_AuthEncFinal` writes padding bytes, causing a heap buffer overflow. Additionally, copying data from `pucEncData` (`GetByteArrayRegion`) is unnecessary as `SDF_AuthEncFinal` is an output-only function for the ciphertext buffer.</div>
                <div class="fix-label">Fix:</div><pre>/* Allocate output buffer with sufficient size for padding (e.g. 256 bytes) */
    /* pucEncData input is ignored as this is a finalization step producing new data */
    ULONG output_len = 256; 
    BYTE *output_buf = (BYTE*)malloc(output_len);
    if (output_buf == NULL) {
        throw_sdf_exception(env, 0x0100001C);
        return NULL;
    }
    /* Do not copy from pucEncData */</pre>
                <div class="issue-source">Reviewer: gemini</div>
            </div>
</div>
<div class="section"><div class="section-title high">High</div>
<div class="issue">
                <div class="issue-title">Heap Buffer Over-read in java_to_native_ECCCipher_alloc</div>
                <div class="issue-location">sdf4j/src/main/native/src/type_conversion.c:350-353</div>
                <pre>/* L - cipher data length */
    native_cipher-&gt;L = (ULONG)l_value;
    if (native_cipher-&gt;L == 0 &amp;&amp; c_len &gt; 0) {
        native_cipher-&gt;L = c_len;
    }</pre>
                <div class="problem"><strong>Issue:</strong> The function allows the `L` field of `ECCCipher` to be set to a value larger than the actual allocated size of the `C` array. `native_cipher->L` is set to `l_value` (from Java object), while the memory allocated depends on the Java byte array length. If a malicious user sets a large `L` and a small `C` array, subsequent native calls (like `SDF_ExternalDecrypt_ECC`) will read past the allocated buffer boundary.</div>
                <div class="fix-label">Fix:</div><pre>/* L - cipher data length */
    /* Ensure L does not exceed actual buffer size to prevent over-read */
    if (l_value &gt; c_len) {
        SDF_LOG_ERROR("java_to_native_ECCCipher_alloc", "Invalid L value: exceeds array length");
        free(native_cipher);
        return NULL;
    }
    native_cipher-&gt;L = (ULONG)l_value;
    if (native_cipher-&gt;L == 0 &amp;&amp; c_len &gt; 0) {
        native_cipher-&gt;L = c_len;
    }</pre>
                <div class="issue-source">Reviewer: gemini</div>
            </div>
</div>
<div class="section"><div class="section-title medium">Medium</div>
<div class="issue">
                <div class="issue-title">Potential Pointer Corruption in JNI_SDF_AuthDec</div>
                <div class="issue-location">sdf4j/src/main/native/src/sdf_jni_symmetric.c:433</div>
                <pre>LONG ret = g_sdf_functions.SDF_AuthDec(
        (HANDLE)sessionHandle,
        (HANDLE)keyHandle,
        (ULONG)algID,
        (BYTE*)iv_buf,
        (ULONG)iv_len,
        (BYTE*)aad_buf,
        (ULONG)aad_len,
        (BYTE*)tag_buf,
        (ULONG *)&amp;tag_len,
        (BYTE*)enc_buf,</pre>
                <div class="problem"><strong>Issue:</strong> The function casts `jsize*` (int*) to `ULONG*` (unsigned int*). While `ULONG` is typedef'd to `unsigned int` in this project (making it 32-bit and likely safe), this cast is dangerous. If `ULONG` were ever changed to `unsigned long` (64-bit on Linux), `SDF_AuthDec` would overwrite stack memory adjacent to `tag_len`.</div>
                <div class="fix-label">Fix:</div><pre>ULONG ul_tag_len = (ULONG)tag_len;
    LONG ret = g_sdf_functions.SDF_AuthDec(
        (HANDLE)sessionHandle,
        (HANDLE)keyHandle,
        (ULONG)algID,
        (BYTE*)iv_buf,
        (ULONG)iv_len,
        (BYTE*)aad_buf,
        (ULONG)aad_len,
        (BYTE*)tag_buf,
        &amp;ul_tag_len,
        (BYTE*)enc_buf,</pre>
                <div class="issue-source">Reviewer: gemini</div>
            </div>
</div>
</div></body></html>