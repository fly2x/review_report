[
  {
    "source": "codex",
    "file": "sdf4j/src/main/java/org/openhitls/sdf4j/types/RSAPublicKey.java",
    "line": "23-33",
    "severity": "high",
    "title": "RSA max size increased to 4096 without matching native struct update",
    "problem": "Java now accepts 4096-bit RSA keys, but JNI native structs are still compiled with 2048-bit buffers (`RSAref_MAX_BITS=2048`). This creates a capability mismatch (truncation/incorrect behavior) and can lead to ABI misuse when interacting with 4096-capable vendor libraries.",
    "code": "/**\n * 最大位数\n */\npublic static final int RSA_MAX_BITS = 4096;",
    "fix": "/**\n * 最大位数（must stay aligned with native RSAref_MAX_BITS）\n */\npublic static final int RSA_MAX_BITS = 2048;"
  },
  {
    "source": "codex",
    "file": "sdf4j/src/main/native/src/sdf_jni_asymmetric.c",
    "line": "379-381",
    "severity": "medium",
    "title": "Output buffer size uses unvalidated RSA bit length",
    "problem": "`output_len` is derived directly from `native_key.bits` with no range check. A malformed/default key (`bits == 0`) can produce `malloc(0)` and pass an invalid output buffer contract into `SDF_ExchangeDigitEnvelopeBaseOnRSA`.",
    "code": "ULONG output_len = (native_key.bits + 7) / 8;\nBYTE *output_buf = (BYTE*)malloc(output_len);",
    "fix": "if (native_key.bits == 0 || native_key.bits > RSAref_MAX_BITS) {\n    THROW_SDF_EXCEPTION(env, SDR_INARGERR, \"Invalid RSA key bits\");\n    return NULL;\n}\n\nULONG output_len = (native_key.bits + 7) / 8;\nBYTE *output_buf = (BYTE*)malloc(output_len);"
  },
  {
    "source": "codex",
    "file": "sdf4j/src/main/native/src/sdf_jni_util.c",
    "line": "135-137",
    "severity": "medium",
    "title": "RSA private operation buffer sizing trusts mutable key metadata",
    "problem": "Buffer length now depends on `priv_key.bits` from Java object state. If `bits` is inconsistent or zero, output buffer can be under-sized/invalid before calling `SDF_ExternalPrivateKeyOperation_RSA`.",
    "code": "/* Allocate output buffer based on key size */\nULONG output_len = (priv_key.bits + 7) / 8;  /* Calculate from private key bits */\nBYTE *output_buf = (BYTE*)malloc(output_len);",
    "fix": "if (priv_key.bits == 0 || priv_key.bits > RSAref_MAX_BITS) {\n    free(input_buf);\n    THROW_SDF_EXCEPTION(env, SDR_INARGERR, \"Invalid RSA key bits\");\n    return NULL;\n}\n\nULONG output_len = (priv_key.bits + 7) / 8;\nBYTE *output_buf = (BYTE*)malloc(output_len);"
  },
  {
    "source": "codex",
    "file": "examples/src/test/java/org/openhitls/sdf4j/examples/AsymmetricOperationTest.java",
    "line": "965-974",
    "severity": "medium",
    "title": "New RSA envelope test uses synthetic invalid input and is flaky",
    "problem": "The test feeds an all-zero envelope (`new byte[256]`) into `SDF_ExchangeDigitEnvelopeBaseOnRSA`. That is not a real digital envelope and can fail on compliant devices with argument/key errors, causing false negatives.",
    "code": "Object[] keyPair = sdf.SDF_GenerateKeyPair_RSA(sessionHandle, 2048);\nassertNotNull(keyPair);\nRSAPublicKey publicKey = (RSAPublicKey) keyPair[0];\nbyte[] deInput = new byte[256];\nbyte[] deOutput = sdf.SDF_ExchangeDigitEnvelopeBaseOnRSA(sessionHandle, keyIndex, publicKey, deInput);",
    "fix": "Object[] keyPair = sdf.SDF_GenerateKeyPair_RSA(sessionHandle, 2048);\nassertNotNull(keyPair);\nRSAPublicKey publicKey = (RSAPublicKey) keyPair[0];\n\nKeyEncryptionResult wrapped = sdf.SDF_GenerateKeyWithIPK_RSA(sessionHandle, keyIndex, 128);\ntry {\n    byte[] deOutput = sdf.SDF_ExchangeDigitEnvelopeBaseOnRSA(\n            sessionHandle, keyIndex, publicKey, wrapped.getEncryptedKey());\n    assertNotNull(deOutput);\n    assertTrue(\"输出长度应大于0\", deOutput.length > 0);\n} finally {\n    sdf.SDF_DestroyKey(sessionHandle, wrapped.getKeyHandle());\n}"
  },
  {
    "source": "codex",
    "file": "docs/API_GUIDE.md",
    "line": "1095-1101",
    "severity": "medium",
    "title": "Documentation overstates RSA capability as 4096-bit",
    "problem": "Multiple table entries now state 4096-bit RSA support, but current JNI native RSA structs remain 2048-bit. This creates incorrect operational expectations for users.",
    "code": "| `SDF_ExportSignPublicKey_RSA(sessionHandle, keyIndex)` | 导出RSA签名公钥  (最大规格4096 bits) |\n| `SDF_ExportEncPublicKey_RSA(sessionHandle, keyIndex)` | 导出RSA加密公钥  (最大规格4096 bits) |\n| `SDF_GenerateKeyWithIPK_RSA(sessionHandle, keyIndex, keyBits)` | 用内部RSA公钥生成会话密钥  (最大规格4096 bits) |\n| `SDF_GenerateKeyWithEPK_RSA(sessionHandle, keyBits, publicKey)` | 用外部RSA公钥生成会话密钥  (最大规格4096 bits) |\n| `SDF_ImportKeyWithISK_RSA(sessionHandle, keyIndex, encryptedKey)` | 用内部RSA私钥导入会话密钥  (最大规格4096 bits) |",
    "fix": "| `SDF_ExportSignPublicKey_RSA(sessionHandle, keyIndex)` | 导出RSA签名公钥 (当前实现最大规格2048 bits) |\n| `SDF_ExportEncPublicKey_RSA(sessionHandle, keyIndex)` | 导出RSA加密公钥 (当前实现最大规格2048 bits) |\n| `SDF_GenerateKeyWithIPK_RSA(sessionHandle, keyIndex, keyBits)` | 用内部RSA公钥生成会话密钥 (当前实现最大规格2048 bits) |\n| `SDF_GenerateKeyWithEPK_RSA(sessionHandle, keyBits, publicKey)` | 用外部RSA公钥生成会话密钥 (当前实现最大规格2048 bits) |\n| `SDF_ImportKeyWithISK_RSA(sessionHandle, keyIndex, encryptedKey)` | 用内部RSA私钥导入会话密钥 (当前实现最大规格2048 bits) |"
  },
  {
    "source": "codex",
    "file": "sdf4j/src/main/java/org/openhitls/sdf4j/constants/AlgorithmID.java",
    "line": "167-271",
    "severity": "low",
    "title": "Newly added algorithm IDs are not handled by getAlgorithmName",
    "problem": "`SGD_SM2`, `SGD_SM2_DECRYPT`, and `SGD_SM3_HMAC` were added, but `getAlgorithmName()` has no matching cases, so these constants resolve to `Unknown(...)`.",
    "code": "public static final int SGD_SM2 = 0x00020100;\n...\npublic static final int SGD_SM2_DECRYPT = 0x00020801;\n...\npublic static final int SGD_SM3_HMAC = 0x00100001;",
    "fix": "// SM2\ncase SGD_SM2:\n    return \"SM2\";\ncase SGD_SM2_1:\n    return \"SM2-Sign\";\ncase SGD_SM2_2:\n    return \"SM2-KeyExchange\";\ncase SGD_SM2_3:\n    return \"SM2-Encrypt\";\ncase SGD_SM2_DECRYPT:\n    return \"SM2-Decrypt\";\n\n// Hash / HMAC\ncase SGD_SM3:\n    return \"SM3\";\ncase SGD_SM3_HMAC:\n    return \"SM3-HMAC\";"
  },
  {
    "source": "codex",
    "file": "docs/API_GUIDE.md",
    "line": "1126",
    "severity": "low",
    "title": "API signature typo in RSA digital envelope entry",
    "problem": "The documented method has an extra closing parenthesis, which makes the signature incorrect for copy/paste usage.",
    "code": "| `SDF_ExchangeDigitEnvelopeBaseOnRSA(sessionHandle, uiKeyIndex, pucPublicKey, pucDEInput))` | RSA 数字信封转换 (最大规格4096 bits) |",
    "fix": "| `SDF_ExchangeDigitEnvelopeBaseOnRSA(sessionHandle, uiKeyIndex, pucPublicKey, pucDEInput)` | RSA 数字信封转换 (最大规格4096 bits) |"
  }
]