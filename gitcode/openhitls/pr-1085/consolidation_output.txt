===ISSUE===
FILE: tls/handshake/recv/src/recv_server_hello.c
LINE: 164
SEVERITY: high
TITLE: EMS force check ignores legacy compatibility field, allowing silent downgrade
REVIEWERS: CODEX
CONFIDENCE: likely
PROBLEM: The new EMS FORCE check only validates `emsMode` without considering the legacy `isSupportExtendedMasterSecret` flag. If existing code sets `isSupportExtendedMasterSecret = true` directly using the old API (HITLS_CFG_SetSupportExtendedMasterSecret), the `emsMode` remains `HITLS_EMS_MODE_PREFER`. Consequently, the client will not enforce EMS and may unexpectedly accept a non-EMS ServerHello, creating a backward compatibility gap that weakens security guarantees.
CODE:
```
if (ctx->config.tlsConfig.emsMode == HITLS_EMS_MODE_FORCE && !serverHello->haveExtendedMasterSecret) {
    BSL_LOG_BINLOG_FIXLEN(BINLOG_ID17084, BSL_LOG_LEVEL_ERR, BSL_LOG_BINLOG_TYPE_RUN,
        "ExtendedMasterSecret err", 0, 0, 0, 0);
    ctx->method.sendAlert(ctx, ALERT_LEVEL_FATAL, ALERT_HANDSHAKE_FAILURE);
    return HITLS_MSG_HANDLE_INVALID_EXTENDED_MASTER_SECRET;
}
```
FIX:
```
int32_t emsMode = ctx->config.tlsConfig.emsMode;
/* Backward compatibility: legacy flag true implies FORCE mode. */
if (ctx->config.tlsConfig.isSupportExtendedMasterSecret) {
    emsMode = HITLS_EMS_MODE_FORCE;
}
if (emsMode == HITLS_EMS_MODE_FORCE && !serverHello->haveExtendedMasterSecret) {
    BSL_LOG_BINLOG_FIXLEN(BINLOG_ID17084, BSL_LOG_LEVEL_ERR, BSL_LOG_BINLOG_TYPE_RUN,
        "ExtendedMasterSecret err", 0, 0, 0, 0);
    ctx->method.sendAlert(ctx, ALERT_LEVEL_FATAL, ALERT_HANDSHAKE_FAILURE);
    return HITLS_MSG_HANDLE_INVALID_EXTENDED_MASTER_SECRET;
}
```
===END===

===ISSUE===
FILE: include/tls/hitls.h
LINE: 1804-1806
SEVERITY: low
TITLE: New API documentation omits invalid-mode error return
REVIEWERS: CODEX
CONFIDENCE: trusted
PROBLEM: The public API documentation for `HITLS_SetExtendedMasterSecretMode` does not document `HITLS_INVALID_INPUT` as a possible return value. However, the underlying implementation (`HITLS_CFG_SetExtendedMasterSecretMode` at config.c:1347-1348) returns this error code when an invalid mode value (other than FORBID, PREFER, or FORCE) is passed. Users calling this API with invalid mode values will receive an undocumented error code.
CODE:
```
/**
 * @brief   Set extended master secret mode.
 *
 * @param   ctx  [IN] TLS connection handle
 * @param   mode [IN] EMS mode. See HITLS_EMS_MODE_*.
 * @retval  HITLS_SUCCESS, if successful.
 * @retval  HITLS_NULL_INPUT, if ctx is NULL.
 */
int32_t HITLS_SetExtendedMasterSecretMode(HITLS_Ctx *ctx, int32_t mode);
```
FIX:
```
/**
 * @brief   Set extended master secret mode.
 *
 * @param   ctx  [IN] TLS connection handle
 * @param   mode [IN] EMS mode. See HITLS_EMS_MODE_*.
 * @retval  HITLS_SUCCESS, if successful.
 * @retval  HITLS_NULL_INPUT, if ctx is NULL.
 * @retval  HITLS_INVALID_INPUT, if mode is invalid.
 */
int32_t HITLS_SetExtendedMasterSecretMode(HITLS_Ctx *ctx, int32_t mode);
```
===END===

===ISSUE===
FILE: tls/handshake/recv/src/recv_client_hello.c
LINE: 1216-1217
SEVERITY: low
TITLE: Unnecessary (void) casts for used parameters
REVIEWERS: CLAUDE
CONFIDENCE: trusted
PROBLEM: The function `ServerProcessClientHelloExt` casts `ctx` and `clientHello` parameters to (void) at the beginning to suppress unused parameter warnings. However, both parameters are actually used later in the function at lines 1219-1220. The (void) casts are misleading and should be removed for the parameters that are used.
CODE:
```
static int32_t ServerProcessClientHelloExt(TLS_Ctx *ctx, const ClientHelloMsg *clientHello)
{
#ifdef HITLS_TLS_FEATURE_EXTENDED_MASTER_SECRET
    int32_t ret = HITLS_SUCCESS;
    (void)ret;
    (void)clientHello;  // Parameter IS used below
    (void)ctx;          // Parameter IS used below
    /* Sets the extended master key flag */
    if (ctx->config.tlsConfig.emsMode == HITLS_EMS_MODE_FORCE &&
        !clientHello->extension.flag.haveExtendedMasterSecret) {
```
FIX:
```
static int32_t ServerProcessClientHelloExt(TLS_Ctx *ctx, const ClientHelloMsg *clientHello)
{
#ifdef HITLS_TLS_FEATURE_EXTENDED_MASTER_SECRET
    (void)ret;  /* Keep this, ret is intentionally unused */
    /* Sets the extended master key flag */
    if (ctx->config.tlsConfig.emsMode == HITLS_EMS_MODE_FORCE &&
        !clientHello->extension.flag.haveExtendedMasterSecret) {
```
===END===

===ISSUE===
FILE: tls/handshake/recv/src/recv_client_hello.c
LINE: 966
SEVERITY: low
TITLE: Unnecessary (void) cast for used parameter
REVIEWERS: CLAUDE
CONFIDENCE: trusted
PROBLEM: In function `ResumeCheckExtendedMasterScret`, the parameter `clientHello` is cast to (void) at line 966, but is actually used at line 970 to check the `haveExtendedMasterSecret` flag. The (void) cast is misleading and should be removed.
CODE:
```
static int32_t ResumeCheckExtendedMasterScret(TLS_Ctx *ctx, const ClientHelloMsg *clientHello, HITLS_Session **sess)
{
    if (*sess == NULL) {
        return HITLS_SUCCESS;
    }
    (void)clientHello;
    bool haveExtMasterSecret = false;
    HITLS_SESS_GetHaveExtMasterSecret(*sess, &haveExtMasterSecret);
    if (haveExtMasterSecret) {
        if (!clientHello->extension.flag.haveExtendedMasterSecret) {
```
FIX:
```
static int32_t ResumeCheckExtendedMasterScret(TLS_Ctx *ctx, const ClientHelloMsg *clientHello, HITLS_Session **sess)
{
    if (*sess == NULL) {
        return HITLS_SUCCESS;
    }
    bool haveExtMasterSecret = false;
    HITLS_SESS_GetHaveExtMasterSecret(*sess, &haveExtMasterSecret);
    if (haveExtMasterSecret) {
        if (!clientHello->extension.flag.haveExtendedMasterSecret) {
```
===END===

===ISSUE===
FILE: tls/config/src/config_default.c
LINE: 307-308
SEVERITY: low
TITLE: Default EMS mode changes behavior vs legacy API
REVIEWERS: CLAUDE
CONFIDENCE: evaluate
PROBLEM: The default initialization sets `emsMode` to `HITLS_EMS_MODE_PREFER` (0), which means clients will send the EMS extension by default (per pack_extensions.c:951: `haveExtendedMasterSecret = (tlsConfig->emsMode != HITLS_EMS_MODE_FORBID)`). The legacy field `isSupportExtendedMasterSecret` is set to false. With PREFER mode, clients WILL send the EMS extension, unlike the previous default behavior. This behavioral change could affect compatibility with servers that do not handle the EMS extension correctly. This needs human evaluation to determine if this is an intentional design change or an unintended side effect.
CODE:
```
static void BasicInitConfig(HITLS_Config *config)
{
    config->isSupportExtendedMasterSecret = false;
    config->emsMode = HITLS_EMS_MODE_PREFER;
```
FIX:
```
static void BasicInitConfig(HITLS_Config *config)
{
    config->isSupportExtendedMasterSecret = false;
    config->emsMode = HITLS_EMS_MODE_FORBID;  /* Don't send EMS extension by default for backward compatibility */
```
===END===